<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulador de Crédito</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="style.css">
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
      $(document).ready(function () {
        // Aplicar máscara de moeda nos campos
        $("#amount-text, #entry-value").mask("R$ ###.###.###,00", {
          reverse: true,
        });
      });
    </script>

    <style>

    </style>
  </head>
  <body>
    <header>
      <img src="images/VFBANK.png" alt="Logo" class="logo" />
      <nav>
        <a href="#">Simulador</a>
        <a href="#" class="highlight">Crédito Pessoal</a>
      </nav>
    </header>
    <div class="container">
      <main>
        <div class="esquerdo">
          <h2>Simule seu Crédito</h2>
          <section class="simulator">
            <div class="input-group">
              <div class="box">
                <label for="amount-text">Quanto precisa?</label>
              </div>
              <div class="input-wrapper">
                <span class="currency-prefix">R$</span>
                <input
                  type="text"
                  id="amount-text"
                  maxlength="20"
                  value=""
                  placeholder="0,00"
                />
              </div>
            </div>

            <div class="input-group">
              <div class="box">
                <label for="entry-value">Qual o valor de entrada?</label>
              </div>
              <div class="input-wrapper">
                <span class="currency-prefix">R$</span>
                <input
                  type="text"
                  id="entry-value"
                  value=""
                  placeholder="0,00"
                />
              </div>
            </div>

            <div class="input-group">
              <div class="box">
                <label for="months-select">Pagar em quantos meses?</label>
                <!-- <div class="details">
                    <span id="monthly-payment-display">R$ 112,50/mês</span>
                  </div> -->
              </div>
              <select id="months-select">
                <option value="#" selected>Selecione um prazo</option>
                <option value="12">12 meses</option>
                <option value="24">24 meses</option>
                <option value="36">36 meses</option>
                <option value="48">48 meses</option>
                <option value="60">60 meses</option>
              </select>
            </div>
            <div class="input-group">
              <div class="box">
                <label for="start-date">Data inicial do vencimento</label>
              </div>
              <input type="date" id="start-date" />
            </div>
            <button class="download-btn" onclick="openPopup()">Simule Já</button>
          </section>
        </div>
      </main>
    </div>

    <div class="popup-overlay" id="popupOverlay">
      <div class="popup-content">
        <span class="close-popup" onclick="closePopup()">×</span>
        <h2>Finalizar Simulação</h2>
        <div class="popup-buttons">
          <div>
            <button class="popup-button" onclick="downloadSimulationPDF()">
              Baixar
            </button>
            <p class="popup-message">Baixe seu PDF clicando no botão acima.</p>
          </div>
          <div>
            <button class="popup-button" onclick="printSimulationPDF()">Imprimir</button>
            <p class="popup-message">
              Imprima o resultado clicando no botão acima.
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>

function openPopup() {
      document.getElementById("popupOverlay").style.display = "block";
    }

    function closePopup() {
      document.getElementById("popupOverlay").style.display = "none";
    }
      function updateSimulation() {
        const amount =
          parseFloat(document.getElementById("amount-text").value) || 0;
        const entryValue =
          parseFloat(document.getElementById("entry-value").value) || 0;
        const months =
          parseInt(document.getElementById("months-select").value) || 1;

        // Calcula o valor restante e a parcela mensal
        const remainingAmount = Math.max(amount - entryValue, 0);
        const monthlyPayment = (remainingAmount / months).toFixed(2);   
      }
      function formatCurrency(value) {
        return value.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

        // Função para gerar o conteúdo do PDF (compartilhada por download e impressão)
  function generatePDFContent() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Pegar valores do formulário
    const amountText = $("#amount-text").val().replace(/[^\d,]/g, "").replace(",", ".");
    const entryValueText = $("#entry-value").val().replace(/[^\d,]/g, "").replace(",", ".");
    const amount = parseFloat(amountText) || 0;
    const entryValue = parseFloat(entryValueText) || 0;
    const months = parseInt($("#months-select").val()) || 1;
    const startDate = document.getElementById("start-date").value;

    if (!startDate) {
      alert("Por favor, insira a data inicial do vencimento.");
      return null;
    }

    // Cálculos
    const remainingAmount = Math.max(amount - entryValue, 0);
    const monthlyPayment = parseFloat((remainingAmount / months).toFixed(2));

    // Adicionar logotipo
    const logoUrl = "images/VFBANK.png";
    doc.addImage(logoUrl, "PNG", 80, 10, 50, 30);

    // Ajustar faixa amarela de "Simulação de Crédito"
    doc.setFillColor(255, 204, 0);
    doc.rect(10, 50, 190, 10, "F");

    // Texto "Simulação de Crédito"
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(255, 255, 255);
    doc.text("Simulação de Crédito", 105, 57, null, null, "center");

    // Tabela de Parâmetros
    const parametersTable = [
      ["Crédito", formatCurrency(amount)],
      ["Entrada", formatCurrency(entryValue)],
      ["Financiado", formatCurrency(remainingAmount)],
      ["Prazo (Meses)", `${months}`],
      ["Parcela (Mensal)", formatCurrency(monthlyPayment)],
    ];

    doc.autoTable({
      startY: 65,
      head: [["PARÂMETROS", "VALORES"]],
      body: parametersTable,
      styles: { fontSize: 10, cellPadding: 5 },
      headStyles: { fillColor: [255, 204, 0], textColor: 0 },
      alternateRowStyles: { fillColor: [245, 245, 245] },
    });

    // Gerar tabela de parcelas com datas de vencimento
    const tableData = [];
    const startDateObj = new Date(startDate);

    let saldoAtual = remainingAmount;
    for (let i = 1; i <= months; i++) {
      const dueDate = new Date(startDateObj);
      dueDate.setMonth(dueDate.getMonth() + (i - 1));
      const formattedDate = dueDate.toLocaleDateString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });

      saldoAtual -= monthlyPayment;
      tableData.push([
        i,
        formattedDate,
        formatCurrency(Math.max(saldoAtual, 0)),
        i === 1 ? formatCurrency(entryValue) : formatCurrency(0),
        formatCurrency(monthlyPayment),
        formatCurrency(monthlyPayment),
      ]);
    }

    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 10,
      head: [
        [
          "PARC",
          "VENCIMENTO",
          "SALDO ATUAL",
          "ENTRADA",
          "PARCELA",
          "PAGAMENTO",
        ],
      ],
      body: tableData,
      styles: { fontSize: 10, cellPadding: 4 },
      headStyles: { fillColor: [0, 0, 0], textColor: 255 },
      alternateRowStyles: { fillColor: [240, 240, 240] },
    });

    return doc;
  }

      function printSimulationPDF() {
        const { jsPDF } = window.jspdf;
        const doc = generatePDFContent(); // Reutilizando a função de geração
        const pdfBlob = doc.output("blob");
        const pdfUrl = URL.createObjectURL(pdfBlob);

        // Abrir o PDF em uma nova aba e acionar a impressão
        const printWindow = window.open(pdfUrl, "_blank");
        printWindow.onload = function () {
          printWindow.print();
        };
      }

      function downloadSimulationPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Pegar valores do formulário
        const amountText = $("#amount-text")
          .val()
          .replace(/[^\d,]/g, "")
          .replace(",", ".");
        const entryValueText = $("#entry-value")
          .val()
          .replace(/[^\d,]/g, "")
          .replace(",", ".");
        const amount = parseFloat(amountText) || 0;
        const entryValue = parseFloat(entryValueText) || 0;
        const months = parseInt($("#months-select").val()) || 1;
        const startDate = document.getElementById("start-date").value;

        if (!startDate) {
          alert("Por favor, insira a data inicial do vencimento.");
          return;
        }

        // Cálculos
        const remainingAmount = Math.max(amount - entryValue, 0);
        const monthlyPayment = parseFloat(
          (remainingAmount / months).toFixed(2)
        );

        // Adicionar logotipo
        const logoUrl = "images/VFBANK.png";
        doc.addImage(logoUrl, "PNG", 80, 10, 50, 30);

        // Ajustar faixa amarela de "Simulação de Crédito"
        doc.setFillColor(255, 204, 0);
        doc.rect(10, 50, 190, 10, "F");

        // Texto "Simulação de Crédito"
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(255, 255, 255);
        doc.text("Simulação de Crédito", 105, 57, null, null, "center");

        // Tabela de Parâmetros
        const parametersTable = [
          ["Crédito", formatCurrency(amount)],
          ["Entrada", formatCurrency(entryValue)],
          ["Financiado", formatCurrency(remainingAmount)],
          ["Prazo (Meses)", `${months}`],
          ["Parcela (Mensal)", formatCurrency(monthlyPayment)],
        ];

        doc.autoTable({
          startY: 65,
          head: [["PARÂMETROS", "VALORES"]],
          body: parametersTable,
          styles: { fontSize: 10, cellPadding: 5 },
          headStyles: { fillColor: [255, 204, 0], textColor: 0 },
          alternateRowStyles: { fillColor: [245, 245, 245] },
        });

        // Gerar tabela de parcelas com datas de vencimento
        const tableData = [];
        const startDateObj = new Date(startDate);

        let saldoAtual = remainingAmount;
        for (let i = 1; i <= months; i++) {
          const dueDate = new Date(startDateObj);
          dueDate.setMonth(dueDate.getMonth() + (i - 1));
          const formattedDate = dueDate.toLocaleDateString("pt-BR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
          });

          saldoAtual -= monthlyPayment;
          tableData.push([
            i,
            formattedDate,
            formatCurrency(Math.max(saldoAtual, 0)),
            i === 1 ? formatCurrency(entryValue) : formatCurrency(0),
            formatCurrency(monthlyPayment),
            formatCurrency(monthlyPayment),
          ]);
        }

        doc.autoTable({
          startY: doc.lastAutoTable.finalY + 10,
          head: [
            [
              "PARC",
              "VENCIMENTO",
              "SALDO ATUAL",
              "ENTRADA",
              "PARCELA",
              "PAGAMENTO",
            ],
          ],
          body: tableData,
          styles: { fontSize: 10, cellPadding: 4 },
          headStyles: { fillColor: [0, 0, 0], textColor: 255 },
          alternateRowStyles: { fillColor: [240, 240, 240] },
        });

        doc.save("simulacao_credito.pdf");
      }

      document
        .getElementById("amount-text")
        .addEventListener("change", updateSimulation);
      document
        .getElementById("entry-value")
        .addEventListener("change", updateSimulation);
      document
        .getElementById("months-select")
        .addEventListener("change", updateSimulation);
    </script>
  </body>
</html>
